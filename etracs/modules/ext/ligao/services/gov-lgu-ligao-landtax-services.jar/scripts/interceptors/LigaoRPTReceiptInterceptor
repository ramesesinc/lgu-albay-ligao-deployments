import com.rameses.annotations.*;

class LigaoRPTReceiptInterceptor {
	@DataContext("entity")
	def em_entity

	@Before(pattern="CashReceiptService.post", eval="#{args[0].payer?.objid!=null && args[0].collectiontype?.handler?.toLowerCase().matches('rpt.*')}", index=-10)
	public void checkBeforePayment( evt ) { 
		def pid = evt.args[0].payer?.objid;
		if (!pid) return ;

		def entity = em_entity.select('mobileno,email').find([objid: pid]).first();
		if (entity && !entity.mobileno) {
			throw new Exception("This payer has no contact information.\nKindly register a mobile no. on its entity record and then save the payment.")
		}
	} 
}